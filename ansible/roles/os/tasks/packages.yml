---
- name: packages | gather the package facts
  ansible.builtin.package_facts:
    manager: auto

- name: packages | upgrade all packages
  ansible.builtin.apt:
    upgrade: full
    update_cache: true
    cache_valid_time: 3600
    autoclean: true
    autoremove: true

- name: packages | install packages
  ansible.builtin.apt:
    name: "{{ os_packages.install }}"
    update_cache: true
    cache_valid_time: 3600
    autoclean: true
  when: os_packages.install

- name: packages | remove snaps
  community.general.snap:
    name: "{{ item }}"
    state: absent
  loop:
    - lxd
    - core18
    - core20
    - snapd
  when:
    - '"snapd" in ansible_facts.packages'
    - '"snapd" in os_packages.remove'

- name: packages | remove packages
  ansible.builtin.apt:
    name: "{{ os_packages.remove }}"
    state: absent
    autoremove: true
    purge: true
  when: os_packages.remove
