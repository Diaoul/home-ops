---
- name: unattended-upgrades | install
  apt:
    name: unattended-upgrades

- name: unattended-upgrades | enable 20auto-upgrades
  shell: |
    set -o pipefail
    echo unattended-upgrades unattended-upgrades/enable_auto_updates boolean true | debconf-set-selections
    dpkg-reconfigure -f noninteractive unattended-upgrades
  args:
    creates: /etc/apt/apt.conf.d/20auto-upgrades
  notify: unattended-upgrades configuration changed

- name: unattended-upgrades | create initial 10periodic
  copy:
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Download-Upgradeable-Packages "0";
      APT::Periodic::AutocleanInterval "0";
    dest: /etc/apt/apt.conf.d/10periodic
    mode: 0644
    force: no
  notify: unattended-upgrades configuration changed

- name: unattended-upgrades | configure autoclean interval to 7 days
  lineinfile:
    dest: /etc/apt/apt.conf.d/10periodic
    regex: 'APT::Periodic::AutocleanInterval'
    line: 'APT::Periodic::AutocleanInterval "7";'
  notify: unattended-upgrades configuration changed

- name: unattended-upgrades | configure to remove unused dependencies
  lineinfile:
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    regex: 'Unattended-Upgrade::Remove-Unused-Dependencies'
    line: 'Unattended-Upgrade::Remove-Unused-Dependencies "true";'
  notify: unattended-upgrades configuration changed

- name: unattended-upgrades | enable service
  service:
    name: unattended-upgrades.service
    enabled: yes
