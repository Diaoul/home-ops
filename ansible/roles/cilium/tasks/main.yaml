---
- name: add cilium helm repository
  community.kubernetes.helm_repository:
    name: cilium
    repo_url: "https://helm.cilium.io/"

- name: install kube-router manifests
  community.kubernetes.k8s:
    # downloaded from:
    # https://raw.githubusercontent.com/cloudnativelabs/kube-router/v1.1.1/daemonset/generic-kuberouter-only-advertise-routes.yaml
    # then modified following cilium's documentation
    definition: "{{ lookup('file', 'kube-router-' + item + '-' + kube_router_version + '.yml') | from_yaml }}"
  loop:
    - daemonset
    - serviceaccount
    - clusterrole
    - clusterrolebinding
    
- name: install cilium
  community.kubernetes.helm:
    update_repo_cache: yes
    release_namespace: kube-system
    name: cilium
    chart_ref: cilium/cilium
    chart_version: "{{ cilium_version }}"
    values: "{{ cilium_values }}"

- name: patch cilium with correct operator image
  community.kubernetes.k8s:
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        namespace: kube-system
        name: cilium-operator
      spec:
        template:
          spec:
            containers:
              - name: cilium-operator
                image: "docker.io/cilium/operator-dev:v{{ cilium_version }}"
