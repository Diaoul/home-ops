---
- name: create tigera-operator namespace
  kubernetes.core.k8s:
    api_version: v1
    kind: namespace
    name: tigera-operator
  run_once: yes
  delegate_to: localhost

- name: install tigera operator
  kubernetes.core.k8s:
    definition: "{{ item }}"
  loop: "{{ lookup('url', 'https://docs.projectcalico.org/manifests/tigera-operator.yaml', split_lines=False) | from_yaml_all | list }}"
  loop_control:
    label:
      kind: "{{ item.kind }}"
      name: "{{ item.metadata.name }}"
  run_once: yes
  delegate_to: localhost

- name: add tigera operator configuration
  kubernetes.core.k8s:
    template: installation.yaml.j2
  run_once: yes
  delegate_to: localhost

- name: enable prometheus metrics in felixconfiguration
  kubernetes.core.k8s:
    api_version: crd.projectcalico.org/v1
    namespace: tigera-operator
    kind: felixconfiguration
    name: default
    definition:
      spec:
        prometheusMetricsEnabled: true
  run_once: yes
  delegate_to: localhost

- name: add bgp configuration
  kubernetes.core.k8s:
    template: bgpconfiguration.yaml.j2
  run_once: yes
  delegate_to: localhost

- name: add bgp peers configuration
  kubernetes.core.k8s:
    template: bgppeer.yaml.j2
  loop: "{{ calico_bgp_peers }}"
  run_once: yes
  delegate_to: localhost
