---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: sharry
  namespace: default
spec:
  interval: 10m
  chart:
    spec:
      # renovate: registryUrl=https://k8s-at-home.com/charts/
      chart: sharry
      version: 5.0.0
      sourceRef:
        kind: HelmRepository
        name: k8s-at-home
        namespace: flux-system
  values:
    image:
      repository: eikek0/sharry
      tag: v1.9.0
    config: |
      sharry.restserver {
        base-url = "https://sharry.${DOMAIN}"
        bind {
          address = "0.0.0.0"
          port = 9090
        }
        backend {
          jdbc {
            url = "jdbc:postgresql://postgresql.db/sharry"
            user = "sharry"
            password = "${SHARRY_POSTGRES_PASSWORD}"
          }
          auth {
            server-secret = "b64:${SHARRY_SERVER_SECRET}"
          }
          signup {
            mode = "invite"
            invite-password = "${SHARRY_INVITE_PASSWORD}"
          }
        }
      }
    podAnnotations:
      configmap.reloader.stakater.com/reload: sharry-config
    ingress:
      main:
        enabled: true
        annotations:
          external-dns.alpha.kubernetes.io/target: ${DOMAIN}
          cert-manager.io/cluster-issuer: letsencrypt-production
          nginx.ingress.kubernetes.io/client-body-buffer-size: "2048m"
          nginx.ingress.kubernetes.io/proxy-body-size: "2048m"
          nginx.ingress.kubernetes.io/proxy-buffering: "off"
        hosts:
          - host: sharry.${DOMAIN}
            paths:
              - path: /
                pathType: Prefix
        tls:
          - hosts:
              - sharry.${DOMAIN}
            secretName: sharry-tls
