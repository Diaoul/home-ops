---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: frigate
  namespace: home-automation
spec:
  interval: 10m
  chart:
    spec:
      chart: app-template
      version: 1.5.1
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  maxHistory: 3
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    image:
      repository: ghcr.io/blakeblackshear/frigate
      tag: 0.12.0-beta10
    env:
      LIBVA_DRIVER_NAME: i965
    service:
      main:
        ports:
          http:
            port: &port 5000
    probes:
      liveness: &probes
        enabled: true
        custom: true
        spec:
          httpGet:
            path: /api/version
            port: *port
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 1
          failureThreshold: 3
      readiness: *probes
      startup:
        enabled: false
    ingress:
      main:
        enabled: true
        annotations:
          external-dns.home.arpa/enabled: "true"
          cert-manager.home.arpa/enabled: "true"
          auth.home.arpa/enabled: "true"
        hosts:
          - host: &host frigate.${DOMAIN}
            paths:
              - path: /
                pathType: Prefix
        tls:
          - hosts:
              - *host
            secretName: frigate-tls
    configMaps:
      config:
        enabled: true
        data:
          config.yml: |
            mqtt:
              host: emqx
              user: ${EMQX_USER_USERNAME}
              password: ${EMQX_USER_PASSWORD}
            database:
              path: /data/frigate.db
            detectors:
              coral:
                type: edgetpu
                device: pci
            ffmpeg:
              hwaccel_args:
                - -hwaccel
                - vaapi
                - -hwaccel_device
                - /dev/dri/renderD128
                - -hwaccel_output_format
                - yuv420p
            birdseye:
              mode: continuous
            record:
              enabled: True
            detect:
              width: 1024
              height: 576
            cameras:
              porch:
                ffmpeg:
                  inputs:
                    - path: rtsp://10.0.4.16:554/s2
                      roles:
                        - detect
                    - path: rtsp://10.0.4.16:554/s0
                      roles:
                        - record
                        - rtmp
                motion:
                  mask:
                    - 825,576,1024,576,1024,344,944,325,794,518
                mqtt:
                  timestamp: false
                  bounding_box: false
                  height: 500
              garage:
                ffmpeg:
                  inputs:
                    - path: rtsp://10.0.4.17:554/s2
                      roles:
                        - detect
                    - path: rtsp://10.0.4.17:554/s0
                      roles:
                        - record
                        - rtmp
                mqtt:
                  timestamp: false
                  bounding_box: false
                  height: 500
              kennel:
                ffmpeg:
                  inputs:
                    - path: rtsp://10.0.4.18:554/s0
                      roles:
                        - record
                        - rtmp
                detect:
                  enabled: False
                mqtt:
                  timestamp: false
                  bounding_box: false
                  height: 500
    persistence:
      data:
        enabled: true
        existingClaim: frigate-data
      config:
        enabled: true
        type: configMap
        name: frigate-config
        subPath: config.yml
        mountPath: /config/config.yml
        readOnly: true
      media:
        enabled: true
        existingClaim: nfs-singularity-recordings
      cache:
        enabled: true
        type: emptyDir
        medium: Memory
        sizeLimit: 1Gi
        mountPath: /dev/shm
      pci:
        enabled: true
        type: hostPath
        hostPath: /dev/apex_0
        hostPathType: CharDevice
    securityContext:
      privileged: true
    podAnnotations:
      configmap.reloader.stakater.com/reload: frigate-config
    nodeSelector:
      google.feature.node.kubernetes.io/coral: "true"
      intel.feature.node.kubernetes.io/gpu: "true"
    resources:
      requests:
        cpu: 700m
        memory: 1.5Gi
        gpu.intel.com/i915: 1
      limits:
        cpu: 1
        memory: 2Gi
        gpu.intel.com/i915: 1
